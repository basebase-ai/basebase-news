<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StoryList - The world's headlines at a glance</title>
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#1a56db", secondary: "#4f46e5" },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Serif+Pro:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <style>
      :where([class^="ri-"])::before {
        content: "\f3c2";
      }
      body {
        font-family: "Source Serif Pro", serif;
        background-color: #f9f9f9;
      }
      .ui-font {
        font-family: "Poppins", sans-serif;
      }
      .font-poppins {
        font-family: "Poppins", sans-serif !important;
      }
      .masthead {
        font-family: "Playfair Display", serif;
        font-weight: 900;
        letter-spacing: -0.03em;
      }
      .motto {
        font-family: "Playfair Display", serif;
        font-style: italic;
        font-weight: 400;
      }
      .column-header {
        font-family: "Playfair Display", serif;
        font-weight: 700;
      }
      .news-headline {
        transition: all 0.2s ease;
        position: relative;
      }
      .news-headline.read {
        color: #9ca3af;
        font-weight: normal;
      }
      .group:hover .news-headline:not(.read) {
        color: #1a56db;
      }
      .news-headline:after {
        content: "";
        position: absolute;
        width: 100%;
        height: 1px;
        bottom: -2px;
        left: 0;
        background-color: #1a56db;
        transform: scaleX(0);
        transform-origin: bottom left;
        transition: transform 0.3s ease;
      }
      .group:hover .news-headline:not(.read):after {
        transform: scaleX(1);
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
      .highlight {
        background-color: #fef08a;
        padding: 0 2px;
        border-radius: 2px;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Source Settings Modal -->
    <div
      id="sourceSettingsModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 id="modalTitle" class="text-xl font-bold">Source Settings</h3>
          <button
            onclick="closeSourceSettingsModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="ri-close-line text-2xl"></i>
          </button>
        </div>
        <form
          id="sourceSettingsForm"
          onsubmit="handleSourceSubmit(event)"
          class="space-y-4"
        >
          <input type="hidden" id="sourceId" />
          <div id="objectIdField" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Object ID</label
            >
            <input
              type="text"
              id="displayObjectId"
              readonly
              class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-500 cursor-not-allowed"
            />
          </div>
          <div>
            <label
              for="name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Name</label
            >
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="homepageUrl"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Homepage URL</label
            >
            <input
              type="url"
              id="homepageUrl"
              name="homepageUrl"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="includeSelector"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Include Selector</label
            >
            <input
              type="text"
              id="includeSelector"
              name="includeSelector"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="excludeSelector"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Exclude Selector (optional)</label
            >
            <input
              type="text"
              id="excludeSelector"
              name="excludeSelector"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="biasScore"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Bias Score</label
            >
            <input
              type="number"
              id="biasScore"
              name="biasScore"
              step="0.01"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="closeSourceSettingsModal()"
              class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              id="submitButton"
              class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
            >
              Update
            </button>
          </div>
        </form>
      </div>
    </div>

    <header
      class="fixed top-0 left-0 right-0 bg-white z-10 border-b border-gray-200 shadow-sm"
    >
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between relative mb-2">
          <div>
            <h1 class="masthead text-3xl">StoryList</h1>
            <p class="motto text-gray-600 text-xs">
              The world's headlines at a glance
            </p>
          </div>
          <div class="flex items-center">
            <div class="relative">
              <input
                type="text"
                id="searchInput"
                placeholder="Search headlines..."
                class="w-64 px-4 py-1.5 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins text-[0.9em]"
              />
              <button
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <i class="ri-search-line"></i>
              </button>
            </div>
            <div id="adminControls" class="hidden ml-4">
              <button
                onclick="openSourceSettingsModal()"
                class="bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center font-poppins"
              >
                <i class="ri-add-line mr-1"></i>Add
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main class="pt-28">
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-4 max-w-7xl mx-auto"
      >
        <!-- Content will be dynamically populated here -->
      </div>
    </main>
    <script>
      let currentSources = [];
      let searchTimeout = null;
      let allHeadlines = [];
      let isAdmin = false;
      let readIds = new Set(
        JSON.parse(localStorage.getItem("readIds") || "[]")
      );

      function debounce(func, wait) {
        return function executedFunction(...args) {
          const later = () => {
            searchTimeout = null;
            func(...args);
          };
          if (searchTimeout) clearTimeout(searchTimeout);
          searchTimeout = window.setTimeout(later, wait);
        };
      }

      function highlightText(text, searchTerm) {
        if (!searchTerm) return text;
        const regex = new RegExp(`(${searchTerm})`, "gi");
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      function filterHeadlines(searchTerm) {
        const scrollContainer = document.querySelector(".grid");
        if (!scrollContainer) return;

        if (!searchTerm || searchTerm.trim() === "") {
          // Reset to original view
          scrollContainer.innerHTML = currentSources
            .map((source) => generateSourceHTML(source))
            .join("");
          return;
        }

        const filteredSources = currentSources
          .map((source) => {
            const filteredHeadlines = source.headlines.filter(
              (headline) =>
                headline.fullHeadline
                  .toLowerCase()
                  .includes(searchTerm.toLowerCase()) ||
                (headline.summary &&
                  headline.summary
                    .toLowerCase()
                    .includes(searchTerm.toLowerCase()))
            );

            if (filteredHeadlines.length === 0) return null;

            return {
              ...source,
              headlines: filteredHeadlines.map((headline) => ({
                ...headline,
                fullHeadline: highlightText(headline.fullHeadline, searchTerm),
                summary: headline.summary
                  ? highlightText(headline.summary, searchTerm)
                  : "",
              })),
            };
          })
          .filter(Boolean);

        scrollContainer.innerHTML = filteredSources
          .map((source) => generateSourceHTML(source))
          .join("");
      }

      function formatTimeAgo(date) {
        const seconds = Math.floor(
          (new Date().getTime() - date.getTime()) / 1000
        );
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return `${days}d`;
        if (hours > 0) return `${hours}h`;
        if (minutes > 0) return `${minutes}m`;
        return "now";
      }

      function markAsRead(headlineId) {
        readIds.add(headlineId);
        if (readIds.size > 100) {
          const idsArray = Array.from(readIds);
          readIds = new Set(idsArray.slice(-100));
        }
        localStorage.setItem("readIds", JSON.stringify([...readIds]));
        const headlineElement = document.querySelector(
          `[data-headline-id="${headlineId}"]`
        );
        if (headlineElement) {
          headlineElement.classList.add("read");
        }
      }

      function generateSourceHTML(source) {
        return `
          <div class="border border-gray-200 rounded-lg h-[300px] flex flex-col">
            <div class="column-header text-lg mb-3 pb-2 border-b border-gray-300 pt-2 flex items-center justify-between px-4">
              <div class="flex-grow">
                <h2 class="flex items-baseline gap-2">
                  <a href="${
                    source.homepageUrl
                  }" target="_blank" rel="noopener" class="hover:text-blue-600 transition-colors">${
          source.name
        }</a>
                  ${
                    source.lastScrapedAt
                      ? `<span class="text-[0.675rem] text-gray-500 font-poppins font-normal">${formatTimeAgo(
                          new Date(source.lastScrapedAt)
                        )}</span>`
                      : ""
                  }
                </h2>
              </div>
              ${
                isAdmin
                  ? `
                <div class="relative inline-block">
                  <button onclick="toggleDropdown('${source._id}')" class="text-gray-500 hover:text-blue-600 transition-colors">
                    <i class="ri-settings-4-line text-lg"></i>
                  </button>
                  <div id="dropdown-${source._id}" class="hidden absolute right-0 mt-1 w-32 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                    <div class="py-1">
                      <button onclick="scrapeSource('${source._id}'); toggleDropdown('${source._id}')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 ui-font font-normal">
                        <i class="ri-refresh-line mr-2"></i>Refresh
                      </button>
                      <button onclick="openSourceSettingsModal('${source._id}'); toggleDropdown('${source._id}')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 ui-font font-normal">
                        <i class="ri-edit-line mr-2"></i>Edit
                      </button>
                      <button onclick="deleteSource('${source._id}'); toggleDropdown('${source._id}')" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100 ui-font font-normal">
                        <i class="ri-delete-bin-line mr-2"></i>Delete
                      </button>
                    </div>
                  </div>
                </div>
              `
                  : ""
              }
            </div>
            <div class="space-y-2 flex-1 overflow-y-auto custom-scrollbar px-4">
              ${source.headlines
                .sort((a, b) => (a.inPageRank ?? 0) - (b.inPageRank ?? 0))
                .map(
                  (headline) => `
                  <div class="truncate">
                    <a href="${headline.articleUrl}" 
                       onmousedown="markAsRead('${headline._id}')"
                       data-headline-id="${headline._id}"
                       class="news-headline block font-semibold text-base leading-tight truncate ${
                         readIds.has(headline._id) ? "read" : ""
                       }" 
                       target="_blank" 
                       rel="noopener">
                      ${headline.fullHeadline}
                    </a>
                  </div>
                `
                )
                .join("")}
            </div>
          </div>
        `;
      }

      function openSourceSettingsModal(sourceId) {
        const form = document.getElementById("sourceSettingsForm");
        const modalTitle = document.getElementById("modalTitle");
        const submitButton = document.getElementById("submitButton");
        const objectIdField = document.getElementById("objectIdField");

        // Reset form
        form.reset();

        if (sourceId) {
          // Edit mode
          const source = currentSources.find((s) => s._id === sourceId);
          if (!source) return;

          modalTitle.textContent = "Edit Source";
          submitButton.textContent = "Update";

          document.getElementById("sourceId").value = source._id;
          document.getElementById("displayObjectId").value = source._id;
          objectIdField.classList.remove("hidden");

          document.getElementById("name").value = source.name;
          document.getElementById("homepageUrl").value = source.homepageUrl;
          document.getElementById("includeSelector").value =
            source.includeSelector;
          document.getElementById("excludeSelector").value =
            source.excludeSelector || "";
          document.getElementById("biasScore").value = source.biasScore || 0;
        } else {
          // Add mode
          modalTitle.textContent = "Add New Source";
          submitButton.textContent = "Add";
          document.getElementById("sourceId").value = "";
          objectIdField.classList.add("hidden");
        }

        document
          .getElementById("sourceSettingsModal")
          .classList.remove("hidden");
      }

      function closeSourceSettingsModal() {
        document.getElementById("sourceSettingsModal").classList.add("hidden");
      }

      async function handleSourceSubmit(event) {
        event.preventDefault();

        const sourceId = document.getElementById("sourceId").value;
        const formData = {
          name: document.getElementById("name").value,
          homepageUrl: document.getElementById("homepageUrl").value,
          includeSelector: document.getElementById("includeSelector").value,
          excludeSelector: document.getElementById("excludeSelector").value,
          biasScore: parseFloat(document.getElementById("biasScore").value),
        };

        try {
          const isEdit = sourceId !== "";
          const response = await fetch(
            isEdit ? `/api/sources/${sourceId}` : "/api/sources",
            {
              method: isEdit ? "PUT" : "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(formData),
            }
          );

          if (!response.ok)
            throw new Error(
              isEdit ? "Failed to update source" : "Failed to add source"
            );

          // Refresh the page to show updated data
          window.location.reload();
        } catch (error) {
          console.error("Error:", error);
          alert(error.message);
        }
      }

      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop()?.split(";").shift();
        return null;
      }

      function toggleDropdown(sourceId) {
        const dropdown = document.getElementById(`dropdown-${sourceId}`);
        if (dropdown) {
          dropdown.classList.toggle("hidden");
        }
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        const dropdowns = document.querySelectorAll("[id^='dropdown-']");
        dropdowns.forEach((dropdown) => {
          const button = dropdown.previousElementSibling;
          if (
            !dropdown.contains(event.target) &&
            !button.contains(event.target)
          ) {
            dropdown.classList.add("hidden");
          }
        });
      });

      async function deleteSource(sourceId) {
        if (!confirm("Are you sure you want to delete this source?")) return;

        try {
          const response = await fetch(`/api/sources/${sourceId}`, {
            method: "DELETE",
          });

          if (!response.ok) throw new Error("Failed to delete source");

          window.location.reload();
        } catch (error) {
          console.error("Error:", error);
          alert(error.message);
        }
      }

      async function scrapeSource(sourceId) {
        try {
          const response = await fetch(`/api/sources/${sourceId}/scrape`, {
            method: "POST",
          });

          if (!response.ok)
            throw new Error("Failed to queue source for scraping");

          const source = currentSources.find((s) => s._id === sourceId);
          alert(`${source?.name || "Source"} has been queued for crawling.`);
        } catch (error) {
          console.error("Error:", error);
          alert(error.message);
        }
      }

      document.addEventListener("DOMContentLoaded", async function () {
        const scrollContainer = document.querySelector(".grid");
        const adminControls = document.getElementById("adminControls");
        const searchInput = document.getElementById("searchInput");
        isAdmin = getCookie("role") === "admin";

        if (searchInput) {
          searchInput.addEventListener(
            "input",
            debounce((e) => {
              const target = e.target;
              const value = target.value.trim();
              filterHeadlines(value);
            }, 300)
          );
        }

        console.log("Cookie value:", document.cookie);
        console.log("Is admin?", isAdmin);

        if (isAdmin && adminControls) {
          adminControls.classList.remove("hidden");
        }

        if (!scrollContainer) return;

        try {
          const response = await fetch("/api/headlines");
          const data = await response.json();

          if (data.status === "ok" && Array.isArray(data.sources)) {
            currentSources = data.sources.sort(
              (a, b) => (a.biasScore ?? 0) - (b.biasScore ?? 0)
            );
            scrollContainer.innerHTML = currentSources
              .map((source) => generateSourceHTML(source))
              .join("");
          }
        } catch (error) {
          console.error("Failed to fetch headlines:", error);
          scrollContainer.innerHTML = `
            <div class="w-full text-center py-8">
              <p class="text-red-600 text-sm">Failed to load headlines. Please try again later.</p>
            </div>
          `;
        }

        // Add smooth scrolling with arrow keys
        window.addEventListener("keydown", function (e) {
          if (e.key === "ArrowRight") {
            scrollContainer.scrollBy({ left: 100, behavior: "smooth" });
          } else if (e.key === "ArrowLeft") {
            scrollContainer.scrollBy({ left: -100, behavior: "smooth" });
          }
        });

        // Add scroll indicators if needed
        const checkScroll = () => {
          const isScrollable =
            scrollContainer.scrollWidth > scrollContainer.clientWidth;
          if (isScrollable) {
            document.body.classList.add("has-horizontal-scroll");
          } else {
            document.body.classList.remove("has-horizontal-scroll");
          }
        };

        // Check on load and resize
        checkScroll();
        window.addEventListener("resize", checkScroll);
      });
    </script>
  </body>
</html>
