<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StoryList - Your news dashboard</title>
    <meta
      name="description"
      content="Stay informed with StoryList - Your personalized news dashboard that brings the world's headlines to you at a glance."
    />
    <meta property="og:title" content="StoryList - Your news dashboard" />
    <meta
      property="og:description"
      content="Stay informed with StoryList - Your personalized news dashboard that brings the world's headlines to you at a glance."
    />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/assets/images/icon_256x256.png" />
    <meta property="og:url" content="https://www.storylist.org" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="StoryList - Your news dashboard" />
    <meta
      name="twitter:description"
      content="Stay informed with StoryList - Your personalized news dashboard that brings the world's headlines to you at a glance."
    />
    <meta name="twitter:image" content="/assets/images/icon_256x256.png" />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/assets/images/icon_32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="128x128"
      href="/assets/images/icon_128x128.png"
    />
    <link rel="apple-touch-icon" href="/assets/images/icon_256x256.png" />
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: { primary: "#1a56db", secondary: "#4f46e5" },
            borderRadius: {
              none: "0px",
              sm: "4px",
              DEFAULT: "8px",
              md: "12px",
              lg: "16px",
              xl: "20px",
              "2xl": "24px",
              "3xl": "32px",
              full: "9999px",
              button: "8px",
            },
          },
        },
      };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Source+Serif+Pro:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <style>
      :where([class^="ri-"])::before {
        content: "\f3c2";
      }
      body {
        font-family: "Source Serif Pro", serif;
        background-color: #f9f9f9;
      }
      .ui-font {
        font-family: "Poppins", sans-serif;
      }
      .font-poppins {
        font-family: "Poppins", sans-serif !important;
      }
      .masthead {
        font-family: "Playfair Display", serif;
        font-weight: 900;
        letter-spacing: -0.03em;
      }
      .motto {
        font-family: "Playfair Display", serif;
        font-style: italic;
        font-weight: 400;
      }
      .column-header {
        font-family: "Playfair Display", serif;
        font-weight: 700;
      }
      .news-headline {
        transition: all 0.2s ease;
        position: relative;
        font-weight: bold;
        color: #111827;
      }
      .news-headline.read {
        color: #9ca3af;
        font-weight: normal;
      }
      .group:hover .news-headline:not(.read) {
        color: #1a56db;
      }
      .news-headline:after {
        content: "";
        position: absolute;
        width: 100%;
        height: 1px;
        bottom: -2px;
        left: 0;
        background-color: #1a56db;
        transform: scaleX(0);
        transform-origin: bottom left;
        transition: transform 0.3s ease;
      }
      .group:hover .news-headline:not(.read):after {
        transform: scaleX(1);
      }
      .tooltip {
        display: none;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 8px;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: max-content;
        max-width: 300px;
        z-index: 1000;
        font-size: 0.875rem;
        line-height: 1.25rem;
        margin-top: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
      .highlight {
        background-color: #fef08a;
        padding: 0 2px;
        border-radius: 2px;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <!-- Source Settings Modal -->
    <div
      id="sourceSettingsModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 id="modalTitle" class="text-xl font-bold font-poppins">
            Source Settings
          </h3>
          <button
            onclick="sourceService.closeSourceSettingsModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="ri-close-line text-2xl"></i>
          </button>
        </div>
        <form
          id="sourceSettingsForm"
          onsubmit="sourceService.handleSourceSubmit(event)"
          class="space-y-4 font-poppins"
        >
          <input type="hidden" id="sourceId" />
          <div id="objectIdField" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >Object ID</label
            >
            <input
              type="text"
              id="displayObjectId"
              readonly
              class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md text-gray-500 cursor-not-allowed"
            />
          </div>
          <div>
            <label
              for="name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Name</label
            >
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="homepageUrl"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Homepage URL</label
            >
            <input
              type="url"
              id="homepageUrl"
              name="homepageUrl"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="rssUrl"
              class="block text-sm font-medium text-gray-700 mb-1"
              >RSS URL (optional)</label
            >
            <input
              type="url"
              id="rssUrl"
              name="rssUrl"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="includeSelector"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Include Selector (optional)</label
            >
            <input
              type="text"
              id="includeSelector"
              name="includeSelector"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="excludeSelector"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Exclude Selector (optional)</label
            >
            <input
              type="text"
              id="excludeSelector"
              name="excludeSelector"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="biasScore"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Bias Score (optional)</label
            >
            <input
              type="number"
              id="biasScore"
              name="biasScore"
              step="0.01"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="tags"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Tags (comma separated)</label
            >
            <input
              type="text"
              id="tags"
              name="tags"
              placeholder="politics, technology, local"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div>
            <label
              for="imageUrl"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Image URL (optional)</label
            >
            <input
              type="url"
              id="imageUrl"
              name="imageUrl"
              placeholder="https://example.com/icon.png"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onclick="sourceService.closeSourceSettingsModal()"
              class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"
            >
              Cancel
            </button>
            <button
              type="submit"
              id="submitButton"
              class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
            >
              Update
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Sign In Modal -->
    <div
      id="signInModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center"
    >
      <div class="bg-white rounded-lg p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold font-poppins">Sign In</h3>
          <button
            onclick="closeSignInModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="ri-close-line text-2xl"></i>
          </button>
        </div>
        <div id="signInFormContainer">
          <form
            id="signInForm"
            onsubmit="handleSignInSubmit(event)"
            class="space-y-4 font-poppins"
          >
            <div>
              <label
                for="firstName"
                class="block text-sm font-medium text-gray-700 mb-1"
                >First Name</label
              >
              <input
                type="text"
                id="firstName"
                name="firstName"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label
                for="lastName"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Last Name</label
              >
              <input
                type="text"
                id="lastName"
                name="lastName"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div>
              <label
                for="email"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Email</label
              >
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
            <div class="flex justify-end space-x-3 pt-4">
              <button
                type="button"
                onclick="closeSignInModal()"
                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors"
              >
                Cancel
              </button>
              <button
                type="submit"
                id="signInSubmitButton"
                class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
              >
                Continue
              </button>
            </div>
          </form>
        </div>
        <div id="signInConfirmation" class="hidden font-poppins">
          <div class="text-center py-4">
            <i class="ri-mail-line text-4xl text-blue-600 mb-4"></i>
            <h3 class="text-xl font-bold mb-2">Check your email</h3>
            <p class="text-gray-600 mb-4">
              We've sent a special sign-in link to your email address. Click the
              link to complete signing in.
            </p>
            <button
              onclick="closeSignInModal()"
              class="px-4 py-2 text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <header
      class="fixed top-0 left-0 right-0 bg-white z-10 border-b border-gray-200 shadow-sm"
    >
      <div class="container mx-auto px-8 py-4 max-w-none mx-4">
        <div class="flex items-center justify-between relative mb-2">
          <div class="flex items-center gap-2">
            <img
              src="/assets/images/logotype_256x55.png"
              alt="StoryList"
              class="h-9"
            />
          </div>
          <div class="flex items-center">
            <div class="relative">
              <input
                type="text"
                id="searchInput"
                placeholder="Search headlines..."
                class="w-64 px-4 py-1.5 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins text-[0.9em]"
              />
              <button
                id="searchClearButton"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"
                onclick="headlineService.clearSearch()"
              >
                <i class="ri-close-line"></i>
              </button>
              <button
                id="searchIcon"
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <i class="ri-search-line"></i>
              </button>
            </div>
            <div id="userSection" class="hidden ml-4 flex items-center">
              <button
                onclick="openCustomizeModal()"
                class="text-gray-600 hover:text-gray-800 font-poppins text-sm mr-4"
              >
                Customize
              </button>
              <div
                id="userAvatar"
                class="w-8 h-8 rounded-full overflow-hidden flex items-center justify-center text-white font-medium text-sm font-poppins cursor-pointer"
                onclick="console.log('Avatar clicked from HTML');"
              ></div>
            </div>
            <button
              id="signInButton"
              onclick="openSignInModal()"
              class="ml-4 text-gray-600 hover:text-gray-800 font-poppins text-sm"
            >
              Customize
            </button>
          </div>
        </div>
      </div>
    </header>
    <main class="pt-28">
      <div
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 px-4 max-w-7xl mx-auto grid"
      >
        <!-- Content will be dynamically populated here -->
      </div>
    </main>

    <!-- Customize Sources Modal -->
    <div
      id="customizeModal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center px-8"
    >
      <div
        class="bg-white rounded-lg p-6 w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold font-poppins">
            Customize Your News Sources
          </h3>
          <button
            onclick="closeCustomizeModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            <i class="ri-close-line text-2xl"></i>
          </button>
        </div>
        <div class="relative mb-6">
          <div class="flex items-center gap-4">
            <div class="relative flex-1">
              <input
                type="text"
                id="sourceSearchInput"
                placeholder="Search news sources..."
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-poppins"
              />
              <button
                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
              >
                <i class="ri-search-line"></i>
              </button>
            </div>
            <div id="adminControlsModal" class="hidden shrink-0">
              <button
                onclick="sourceService.openSourceSettingsModal()"
                class="bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors text-sm flex items-center font-poppins"
              >
                <i class="ri-add-line mr-1"></i>Add
              </button>
            </div>
          </div>
        </div>
        <div
          id="sourcesGrid"
          class="grid grid-cols-4 gap-4 overflow-y-auto flex-1 custom-scrollbar"
        >
          <!-- Sources will be dynamically populated here -->
        </div>
      </div>
    </div>

    <script src="/js/auth.js" type="module"></script>
    <script src="/js/sources.js" type="module"></script>
    <script src="/js/headlines.js" type="module"></script>
    <script src="/js/main.js" type="module"></script>
    <script>
      // Wait for modules to load
      window.addEventListener("load", () => {
        if (!window.sourceService) {
          console.error("sourceService not loaded");
        } else {
          console.log("sourceService loaded successfully");
        }
      });
    </script>
    <script>
      function createSourceCard(source) {
        const card = document.createElement("div");
        card.className =
          "bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow";

        const sourceName = document.createElement("div");
        sourceName.className = "flex items-center gap-2 mb-2";

        if (source.imageUrl) {
          const img = document.createElement("img");
          img.src = source.imageUrl;
          img.alt = source.name;
          img.className = "w-8 h-8 rounded-full object-cover";
          sourceName.appendChild(img);
        }

        const name = document.createElement("h3");
        name.className = "font-medium text-gray-900";
        name.textContent = source.name;
        sourceName.appendChild(name);

        card.appendChild(sourceName);
        // ... rest of the card creation code ...
      }

      function renderSourcesGrid(sources, searchTerm = "") {
        const grid = document.getElementById("sourcesGrid");
        const filteredSources = searchTerm
          ? sources.filter(
              (source) =>
                source.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (source.tags &&
                  source.tags.some((tag) =>
                    tag.toLowerCase().includes(searchTerm.toLowerCase())
                  ))
            )
          : sources;

        grid.innerHTML = filteredSources
          .map((source) => {
            const sourceId = source._id.toString();
            const isChecked = state.currentUser?.sourceIds?.includes(sourceId);

            return `
              <div class="border border-gray-200 rounded-lg p-4" data-source-id="${sourceId}">
                <div class="flex items-start justify-between">
                  <div class="flex items-start gap-3">
                    <div class="cursor-move text-gray-400 hover:text-gray-600">
                      <i class="ri-drag-move-line"></i>
                    </div>
                    <input
                      type="checkbox"
                      id="source-${source._id}"
                      ${isChecked ? "checked" : ""}
                      onchange="handleSourceToggle('${source._id}')"
                      class="mt-1 h-4 w-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                    />
                    <!-- Rest of the source card HTML -->
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        // Initialize Sortable
        if (state.currentUser) {
          new Sortable(grid, {
            animation: 150,
            handle: ".cursor-move",
            onEnd: async function (evt) {
              const newOrder = Array.from(grid.children).map(
                (el) => el.dataset.sourceId
              );
              try {
                const response = await fetch("/api/users/me/sources", {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    sourceIds: newOrder,
                  }),
                });

                if (!response.ok) {
                  throw new Error("Failed to update source order");
                }

                const updatedUser = await response.json();
                state.currentUser = updatedUser.user;
              } catch (error) {
                console.error("Failed to update source order:", error);
                alert("Failed to update source order. Please try again.");
              }
            },
          });
        }
      }
    </script>
  </body>
</html>
